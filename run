#!/bin/bash

# Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Go bin Ð² PATH
export PATH=$PATH:$(go env GOPATH)/bin

echo "ðŸš€ Starting Main Project..."
echo ""

# Ð¦Ð²ÐµÑ‚Ð° Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð°
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m' # No Color

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð¿Ð¾Ñ€Ñ‚Ð°
check_port() {
    lsof -ti:$1 >/dev/null 2>&1
}

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ¸ Ð¿Ð¾Ñ€Ñ‚Ð°
clean_port() {
    if check_port $1; then
        echo -e "${YELLOW}ðŸ§¹ Cleaning port $1...${NC}"
        lsof -ti:$1 | xargs kill -9 2>/dev/null || true
        sleep 1
    fi
}

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ HTTP endpoint
check_http() {
    local url=$1
    local name=$2
    echo -e "${BLUE}ðŸ” Checking $name...${NC}"
    
    response=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 5 "$url" 2>/dev/null)
    
    if [ "$response" = "200" ] || [ "$response" = "404" ] || [ "$response" = "503" ]; then
        echo -e "${GREEN}âœ… $name is reachable (HTTP $response)${NC}"
        return 0
    else
        echo -e "${RED}âŒ $name is not reachable (HTTP $response)${NC}"
        return 1
    fi
}

# Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ PostgreSQL
check_postgres() {
    echo -e "${BLUE}ðŸ” Checking PostgreSQL connection...${NC}"
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ .env
    if [ ! -f "backend/.env" ]; then
        echo -e "${RED}âŒ .env file not found in backend/${NC}"
        return 1
    fi
    
    # Ð§Ð¸Ñ‚Ð°ÐµÐ¼ DATABASE_URL
    DB_URL=$(grep "^DATABASE_URL=" backend/.env | cut -d '=' -f2-)
    
    if [ -z "$DB_URL" ]; then
        echo -e "${RED}âŒ DATABASE_URL not found in .env${NC}"
        return 1
    fi
    
    # ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ð‘Ð”
    DB_HOST=$(echo "$DB_URL" | sed -n 's/.*@\([^:]*\):.*/\1/p')
    DB_PORT=$(echo "$DB_URL" | sed -n 's/.*:\([0-9]*\)\/.*/\1/p')
    DB_NAME=$(echo "$DB_URL" | sed -n 's/.*\/\([^?]*\).*/\1/p')
    
    echo -e "${BLUE}   Host: $DB_HOST:$DB_PORT${NC}"
    echo -e "${BLUE}   Database: $DB_NAME${NC}"
    
    # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Go ÑÐºÑ€Ð¸Ð¿Ñ‚ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸
    echo -e "${BLUE}   Testing connection...${NC}"
    
    check_result=$(cd backend/scripts/check_db && go run main.go 2>&1)
    check_status=$?
    
    if [ $check_status -eq 0 ] && [ "$check_result" = "OK" ]; then
        echo -e "${GREEN}âœ… PostgreSQL connection successful${NC}"
        echo -e "${GREEN}   All required tables exist${NC}"
        return 0
    else
        echo -e "${RED}âŒ PostgreSQL connection failed${NC}"
        echo -e "${RED}   Error: $check_result${NC}"
        return 1
    fi
}

# ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÐºÑÑˆÐ°
echo -e "${BLUE}ðŸ§¹ Cleaning cache...${NC}"
rm -rf frontend/.next 2>/dev/null || true
echo -e "${GREEN}âœ… Cache cleared${NC}"
echo ""

# ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð¿Ð¾Ñ€Ñ‚Ð¾Ð²
echo -e "${BLUE}ðŸ§¹ Cleaning up ports...${NC}"
clean_port 8000  # Main Backend
clean_port 3000  # Main Frontend
echo -e "${GREEN}âœ… Ports cleared${NC}"
echo ""

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð²Ð½ÐµÑˆÐ½Ð¸Ñ… Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ð¹
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}ðŸ” Checking external connections...${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Gateway
GATEWAY_OK=false
if check_http "https://my-projects-gateway-zp.crv1ic.easypanel.host/" "API Gateway"; then
    GATEWAY_OK=true
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ health endpoint
    echo -e "${BLUE}ðŸ” Checking Gateway services...${NC}"
    gateway_health=$(curl -s "https://my-projects-gateway-zp.crv1ic.easypanel.host/health" 2>/dev/null)
    
    if [ ! -z "$gateway_health" ]; then
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ main_backend
        main_status=$(echo "$gateway_health" | grep -o '"main_backend":{"healthy":[^}]*}' | grep -o 'true\|false')
        
        if [ "$main_status" = "true" ]; then
            echo -e "${GREEN}   âœ… Main Backend is healthy in Gateway${NC}"
        else
            echo -e "${YELLOW}   âš ï¸  Main Backend is not healthy in Gateway (will start locally)${NC}"
        fi
    fi
    
    # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ CORS Ð´Ð»Ñ localhost:3000
    echo -e "${BLUE}ðŸ” Checking Gateway CORS for localhost:3000...${NC}"
    cors_check=$(curl -s -H "Origin: http://localhost:3000" -H "Access-Control-Request-Method: GET" -X OPTIONS "https://my-projects-gateway-zp.crv1ic.easypanel.host/api/health" -i 2>/dev/null | grep -i "access-control-allow-origin")
    
    if echo "$cors_check" | grep -q "localhost:3000"; then
        echo -e "${GREEN}   âœ… CORS configured for localhost:3000${NC}"
    else
        echo -e "${YELLOW}   âš ï¸  CORS may not be configured for localhost:3000${NC}"
        echo -e "${YELLOW}   Add 'http://localhost:3000' to allowedOrigins in Gateway${NC}"
    fi
else
    echo -e "${YELLOW}âš ï¸  Gateway is not reachable - will use local mode${NC}"
fi
echo ""

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° PostgreSQL
POSTGRES_OK=false
if check_postgres; then
    POSTGRES_OK=true
else
    echo -e "${RED}âŒ Cannot connect to PostgreSQL - please check DATABASE_URL in .env${NC}"
    exit 1
fi
echo ""

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° S3 (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)
S3_OK=false
USE_S3=$(grep "^USE_S3=" backend/.env | cut -d '=' -f2-)
if [ "$USE_S3" = "true" ]; then
    echo -e "${BLUE}ðŸ” Checking S3 storage...${NC}"
    
    s3_result=$(cd backend/scripts/test_s3 && go run main.go 2>&1 | tail -1)
    
    if echo "$s3_result" | grep -q "All S3 tests passed"; then
        echo -e "${GREEN}âœ… S3 storage is accessible${NC}"
        S3_OK=true
    else
        echo -e "${YELLOW}âš ï¸  S3 storage check failed${NC}"
        echo -e "${YELLOW}   Will fall back to local storage${NC}"
        S3_OK=false
    fi
    echo ""
else
    echo -e "${BLUE}ðŸ“ Using local file storage (USE_S3=false)${NC}"
    echo ""
fi

# Ð˜Ñ‚Ð¾Ð³Ð¾Ð²Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ°
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}ðŸ“Š Connection Status:${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
if [ "$GATEWAY_OK" = true ]; then
    echo -e "${GREEN}âœ… API Gateway: Connected${NC}"
    echo -e "${GREEN}   CORS: Configured for localhost:3000${NC}"
else
    echo -e "${YELLOW}âš ï¸  API Gateway: Not available (local mode)${NC}"
fi
if [ "$POSTGRES_OK" = true ]; then
    echo -e "${GREEN}âœ… PostgreSQL: Connected${NC}"
else
    echo -e "${RED}âŒ PostgreSQL: Not connected${NC}"
fi
if [ "$USE_S3" = "true" ]; then
    if [ "$S3_OK" = true ]; then
        echo -e "${GREEN}âœ… S3 Storage: Connected${NC}"
    else
        echo -e "${YELLOW}âš ï¸  S3 Storage: Not available (using local)${NC}"
    fi
else
    echo -e "${BLUE}ðŸ“ File Storage: Local${NC}"
fi
echo ""
echo -e "${BLUE}ðŸ“ Architecture:${NC}"
echo -e "   Frontend (localhost:3000) â†’ Gateway (remote) â†’ Backend (localhost:8000)"
echo ""

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ PostgreSQL Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½
if [ "$POSTGRES_OK" = false ]; then
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo -e "${RED}âŒ Cannot start without PostgreSQL connection${NC}"
    echo -e "${RED}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
    echo ""
    echo -e "${YELLOW}Please check:${NC}"
    echo -e "  1. DATABASE_URL is set correctly in backend/.env"
    echo -e "  2. PostgreSQL server is running and accessible"
    echo -e "  3. Required tables (users, chats, messages) exist"
    echo ""
    exit 1
fi

# Ð—Ð°Ð¿ÑƒÑÐº Main Backend
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}ðŸš€ Starting services...${NC}"
echo -e "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

echo -e "${BLUE}ðŸ”§ Starting Main Backend on port 8000...${NC}"

# ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ air
if command -v air &> /dev/null; then
    (cd backend && air) > /tmp/main-backend.log 2>&1 &
    BACKEND_PID=$!
    echo -e "${BLUE}   Using air for hot reload${NC}"
else
    (cd backend && go run main.go) > /tmp/main-backend.log 2>&1 &
    BACKEND_PID=$!
    echo -e "${YELLOW}   air not found, using 'go run' (install air for hot reload)${NC}"
fi

# Ð–Ð´ÐµÐ¼ Ð¿Ð¾ÐºÐ° Backend Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑÑ (Ð¼Ð°ÐºÑÐ¸Ð¼ÑƒÐ¼ 30 ÑÐµÐºÑƒÐ½Ð´)
echo -e "${BLUE}   Waiting for Backend to start...${NC}"
BACKEND_READY=false
for i in {1..30}; do
    if check_port 8000; then
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ health endpoint
        health_check=$(curl -s http://localhost:8000/api/health 2>/dev/null)
        if [ ! -z "$health_check" ] && echo "$health_check" | grep -q "ok"; then
            BACKEND_READY=true
            break
        fi
    fi
    sleep 1
done

if [ "$BACKEND_READY" = true ]; then
    echo -e "${GREEN}âœ… Main Backend started (PID: $BACKEND_PID)${NC}"
    echo -e "${GREEN}   Health check: OK${NC}"
else
    echo -e "${RED}âŒ Failed to start Main Backend (timeout after 30s)${NC}"
    echo -e "${RED}Last 30 lines of log:${NC}"
    tail -30 /tmp/main-backend.log
    kill $BACKEND_PID 2>/dev/null
    exit 1
fi
echo ""

# Ð—Ð°Ð¿ÑƒÑÐº Main Frontend
echo -e "${BLUE}âš›ï¸  Starting Main Frontend on port 3000...${NC}"
(cd frontend && npm run dev) > /tmp/main-frontend.log 2>&1 &
FRONTEND_PID=$!

# Ð–Ð´ÐµÐ¼ Ð¿Ð¾ÐºÐ° Frontend Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑÑ (Ð¼Ð°ÐºÑÐ¸Ð¼ÑƒÐ¼ 60 ÑÐµÐºÑƒÐ½Ð´)
echo -e "${BLUE}   Waiting for Frontend to start...${NC}"
FRONTEND_READY=false
for i in {1..60}; do
    if check_port 3000; then
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Next.js Ð³Ð¾Ñ‚Ð¾Ð²
        frontend_check=$(curl -s http://localhost:3000 2>/dev/null)
        if [ ! -z "$frontend_check" ]; then
            FRONTEND_READY=true
            break
        fi
    fi
    sleep 1
done

if [ "$FRONTEND_READY" = true ]; then
    echo -e "${GREEN}âœ… Main Frontend started (PID: $FRONTEND_PID)${NC}"
else
    echo -e "${RED}âŒ Failed to start Main Frontend (timeout after 60s)${NC}"
    echo -e "${RED}Last 30 lines of log:${NC}"
    tail -30 /tmp/main-frontend.log
    kill $BACKEND_PID $FRONTEND_PID 2>/dev/null
    exit 1
fi
echo ""

# Ð£ÑÐ¿ÐµÑˆÐ½Ñ‹Ð¹ Ð·Ð°Ð¿ÑƒÑÐº
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${GREEN}âœ… Main Project successfully started!${NC}"
echo -e "${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
echo -e "${BLUE}ðŸ“ Local Services:${NC}"
echo -e "   ðŸ”§ Main Backend:    http://localhost:8000"
echo -e "   ðŸŒ Main Frontend:   ${GREEN}http://localhost:3000${NC}"
echo ""
echo -e "${BLUE}ðŸ“ External Services:${NC}"
if [ "$GATEWAY_OK" = true ]; then
    echo -e "   ðŸŒ API Gateway:     ${GREEN}https://my-projects-gateway-zp.crv1ic.easypanel.host/${NC}"
else
    echo -e "   ðŸŒ API Gateway:     ${YELLOW}Not available${NC}"
fi
if [ "$POSTGRES_OK" = true ]; then
    echo -e "   ðŸ’¾ PostgreSQL:      ${GREEN}Connected${NC}"
fi
if [ "$USE_S3" = "true" ] && [ "$S3_OK" = true ]; then
    echo -e "   â˜ï¸  S3 Storage:      ${GREEN}Connected (FirstVDS)${NC}"
elif [ "$USE_S3" = "true" ]; then
    echo -e "   â˜ï¸  S3 Storage:      ${YELLOW}Fallback to local${NC}"
else
    echo -e "   ðŸ“ File Storage:    ${BLUE}Local${NC}"
fi
echo ""
echo -e "${YELLOW}ðŸ“ Logs:${NC}"
echo -e "   Backend:  tail -f /tmp/main-backend.log"
echo -e "   Frontend: tail -f /tmp/main-frontend.log"
echo ""
echo -e "${YELLOW}ðŸ”§ Useful commands:${NC}"
echo -e "   Check Backend:  curl http://localhost:8000/api/health"
echo -e "   Check Gateway:  curl https://my-projects-gateway-zp.crv1ic.easypanel.host/health"
echo ""
echo -e "${YELLOW}Press Ctrl+C to stop all services${NC}"
echo ""

# ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ctrl+C
trap "echo ''; echo -e '${RED}ðŸ›‘ Stopping all services...${NC}'; kill $BACKEND_PID $FRONTEND_PID 2>/dev/null; sleep 1; echo -e '${GREEN}âœ… All services stopped${NC}'; exit" INT

# ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ
wait
