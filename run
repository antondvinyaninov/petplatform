#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–ø—É—Å–∫–∞ admin –ø–∞–Ω–µ–ª–∏
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./run

set -e

echo "üöÄ –ó–∞–ø—É—Å–∫ Admin Panel..."
echo ""

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
if [ ! -f "backend/.env" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  –§–∞–π–ª backend/.env –Ω–µ –Ω–∞–π–¥–µ–Ω${NC}"
    echo "–°–æ–∑–¥–∞–π—Ç–µ –µ–≥–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ backend/.env.example"
    exit 1
fi

if [ ! -f "frontend/.env.local" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  –§–∞–π–ª frontend/.env.local –Ω–µ –Ω–∞–π–¥–µ–Ω${NC}"
    echo "–°–æ–∑–¥–∞–π—Ç–µ –µ–≥–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ frontend/.env.example"
    exit 1
fi

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ
cleanup() {
    echo ""
    echo -e "${YELLOW}üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤...${NC}"
    kill $BACKEND_PID $FRONTEND_PID 2>/dev/null
    exit 0
}

trap cleanup SIGINT SIGTERM

# –ó–∞–ø—É—Å–∫ backend
echo -e "${BLUE}üì¶ –ó–∞–ø—É—Å–∫ Backend (Go)...${NC}"
cd backend
go run main.go > ../backend.log 2>&1 &
BACKEND_PID=$!
cd ..
echo -e "${GREEN}‚úÖ Backend –∑–∞–ø—É—â–µ–Ω (PID: $BACKEND_PID)${NC}"
echo "   –õ–æ–≥–∏: tail -f backend.log"
echo ""

# –ñ–¥–µ–º –ø–æ–∫–∞ backend –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è
sleep 2

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ backend –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
if ! curl -s http://localhost:9000/api/admin/health > /dev/null; then
    echo -e "${YELLOW}‚ö†Ô∏è  Backend –Ω–µ –∑–∞–ø—É—Å—Ç–∏–ª—Å—è, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: tail -f backend.log${NC}"
    kill $BACKEND_PID 2>/dev/null
    exit 1
fi

# –ó–∞–ø—É—Å–∫ frontend
echo -e "${BLUE}üé® –ó–∞–ø—É—Å–∫ Frontend (Next.js)...${NC}"
cd frontend
npm run dev > ../frontend.log 2>&1 &
FRONTEND_PID=$!
cd ..
echo -e "${GREEN}‚úÖ Frontend –∑–∞–ø—É—â–µ–Ω (PID: $FRONTEND_PID)${NC}"
echo "   –õ–æ–≥–∏: tail -f frontend.log"
echo ""

# –ñ–¥–µ–º –ø–æ–∫–∞ frontend –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è
echo "‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ frontend..."
sleep 5

echo ""
echo -e "${GREEN}‚úÖ –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã!${NC}"
echo ""
echo "üìä Admin Panel: http://localhost:4000"
echo "üîß Backend API: http://localhost:9000"
echo "üåê Gateway: https://api.zooplatforma.ru"
echo ""
echo "üìù –õ–æ–≥–∏:"
echo "   Backend:  tail -f backend.log"
echo "   Frontend: tail -f frontend.log"
echo ""
echo "–ù–∞–∂–º–∏—Ç–µ Ctrl+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤"
echo ""

# –ñ–¥–µ–º —Å–∏–≥–Ω–∞–ª–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
wait
