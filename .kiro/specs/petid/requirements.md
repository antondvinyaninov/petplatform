# Документ требований: CRUD Endpoints для PetID API

## Введение

PetID - это микросервис, который является Single Source of Truth для всех данных о питомцах в экосистеме ZooPlatforma. Недавно были добавлены новые таблицы в базу данных (pet_vaccinations, pet_treatments, pet_change_log) и обновлена таблица medical_records. Необходимо реализовать полноценные CRUD endpoints для работы с этими данными через REST API.

## Глоссарий

- **PetID** - микросервис для управления данными о питомцах
- **CRUD** - Create, Read, Update, Delete операции
- **Vaccination** - прививка питомца
- **Treatment** - обработка питомца (дегельминтизация, обработка от блох и т.д.)
- **Medical_Record** - медицинская запись о посещении ветеринара
- **Changelog** - история изменений данных питомца
- **JWT** - JSON Web Token для аутентификации
- **Handler** - обработчик HTTP запросов в Go
- **Gateway** - API Gateway для маршрутизации запросов между сервисами

## Требования

### Требование 1: CRUD операции для прививок

**User Story:** Как пользователь системы, я хочу управлять прививками питомца, чтобы вести полную историю вакцинации.

#### Критерии приемки

1. WHEN пользователь запрашивает список прививок питомца, THEN система SHALL вернуть все прививки этого питомца, отсортированные по дате
2. WHEN пользователь создает новую прививку с валидными данными, THEN система SHALL сохранить прививку в базу данных и вернуть созданную запись
3. WHEN пользователь создает прививку без обязательных полей (date, vaccine_name), THEN система SHALL вернуть ошибку валидации с описанием отсутствующих полей
4. WHEN пользователь обновляет существующую прививку, THEN система SHALL обновить данные и вернуть обновленную запись
5. WHEN пользователь удаляет прививку, THEN система SHALL удалить запись из базы данных и вернуть подтверждение
6. WHEN пользователь пытается получить прививки несуществующего питомца, THEN система SHALL вернуть ошибку 404
7. WHEN пользователь создает или обновляет прививку, THEN система SHALL автоматически создать запись в pet_change_log

### Требование 2: CRUD операции для обработок

**User Story:** Как пользователь системы, я хочу управлять обработками питомца, чтобы отслеживать профилактические процедуры.

#### Критерии приемки

1. WHEN пользователь запрашивает список обработок питомца, THEN система SHALL вернуть все обработки этого питомца, отсортированные по дате
2. WHEN пользователь создает новую обработку с валидными данными, THEN система SHALL сохранить обработку в базу данных и вернуть созданную запись
3. WHEN пользователь создает обработку без обязательных полей (date, product_name), THEN система SHALL вернуть ошибку валидации с описанием отсутствующих полей
4. WHEN пользователь обновляет существующую обработку, THEN система SHALL обновить данные и вернуть обновленную запись
5. WHEN пользователь удаляет обработку, THEN система SHALL удалить запись из базы данных и вернуть подтверждение
6. WHEN пользователь создает или обновляет обработку, THEN система SHALL автоматически создать запись в pet_change_log

### Требование 3: CRUD операции для медицинских записей

**User Story:** Как пользователь системы, я хочу управлять медицинскими записями питомца, чтобы вести полную медицинскую историю.

#### Критерии приемки

1. WHEN пользователь запрашивает список медицинских записей питомца, THEN система SHALL вернуть все записи этого питомца, отсортированные по дате
2. WHEN пользователь создает новую медицинскую запись с валидными данными, THEN система SHALL сохранить запись в базу данных и вернуть созданную запись
3. WHEN пользователь создает медицинскую запись без обязательных полей (date, title), THEN система SHALL вернуть ошибку валидации с описанием отсутствующих полей
4. WHEN пользователь обновляет существующую медицинскую запись, THEN система SHALL обновить данные и вернуть обновленную запись
5. WHEN пользователь удаляет медицинскую запись, THEN система SHALL удалить запись из базы данных и вернуть подтверждение
6. WHEN пользователь создает или обновляет медицинскую запись, THEN система SHALL автоматически создать запись в pet_change_log

### Требование 4: Получение истории изменений

**User Story:** Как пользователь системы, я хочу просматривать историю изменений питомца, чтобы отслеживать все действия с карточкой.

#### Критерии приемки

1. WHEN пользователь запрашивает историю изменений питомца, THEN система SHALL вернуть все записи из pet_change_log для этого питомца, отсортированные по дате (от новых к старым)
2. WHEN в истории изменений есть записи с user_id, THEN система SHALL включить информацию о пользователе (имя, аватар)
3. WHEN пользователь запрашивает историю несуществующего питомца, THEN система SHALL вернуть ошибку 404

### Требование 5: Аутентификация и авторизация

**User Story:** Как администратор системы, я хочу, чтобы все endpoints были защищены аутентификацией, чтобы предотвратить несанкционированный доступ.

#### Критерии приемки

1. WHEN пользователь отправляет запрос без JWT токена, THEN система SHALL вернуть ошибку 401 Unauthorized
2. WHEN пользователь отправляет запрос с невалидным JWT токеном, THEN система SHALL вернуть ошибку 401 Unauthorized
3. WHEN пользователь отправляет запрос с валидным JWT токеном, THEN система SHALL обработать запрос и вернуть результат

### Требование 6: Валидация входных данных

**User Story:** Как разработчик, я хочу, чтобы система валидировала все входные данные, чтобы предотвратить некорректные записи в базе данных.

#### Критерии приемки

1. WHEN пользователь отправляет запрос с невалидным JSON, THEN система SHALL вернуть ошибку 400 Bad Request с описанием проблемы
2. WHEN пользователь отправляет запрос с отсутствующими обязательными полями, THEN система SHALL вернуть ошибку 400 Bad Request с перечислением отсутствующих полей
3. WHEN пользователь отправляет запрос с невалидными типами данных, THEN система SHALL вернуть ошибку 400 Bad Request с описанием ошибки
4. WHEN пользователь отправляет запрос с невалидным форматом даты, THEN система SHALL вернуть ошибку 400 Bad Request

### Требование 7: Обработка ошибок

**User Story:** Как пользователь API, я хочу получать понятные сообщения об ошибках, чтобы понимать, что пошло не так.

#### Критерии приемки

1. WHEN происходит ошибка валидации, THEN система SHALL вернуть JSON с полем "error" и описанием проблемы
2. WHEN происходит ошибка базы данных, THEN система SHALL вернуть ошибку 500 Internal Server Error
3. WHEN запрашивается несуществующий ресурс, THEN система SHALL вернуть ошибку 404 Not Found
4. WHEN используется неподдерживаемый HTTP метод, THEN система SHALL вернуть ошибку 405 Method Not Allowed
5. THE система SHALL логировать все ошибки для последующего анализа

### Требование 8: Автоматическое логирование изменений

**User Story:** Как администратор системы, я хочу, чтобы все изменения автоматически логировались, чтобы иметь полную историю действий.

#### Критерии приемки

1. WHEN создается новая прививка, THEN система SHALL создать запись в pet_change_log с типом "vaccination" и описанием добавленной прививки
2. WHEN обновляется прививка, THEN система SHALL создать запись в pet_change_log с типом "vaccination" и описанием изменений
3. WHEN удаляется прививка, THEN система SHALL создать запись в pet_change_log с типом "vaccination" и описанием удаленной прививки
4. WHEN создается новая обработка, THEN система SHALL создать запись в pet_change_log с типом "treatment" и описанием добавленной обработки
5. WHEN обновляется обработка, THEN система SHALL создать запись в pet_change_log с типом "treatment" и описанием изменений
6. WHEN удаляется обработка, THEN система SHALL создать запись в pet_change_log с типом "treatment" и описанием удаленной обработки
7. WHEN создается новая медицинская запись, THEN система SHALL создать запись в pet_change_log с типом "medical_record" и описанием добавленной записи
8. WHEN обновляется медицинская запись, THEN система SHALL создать запись в pet_change_log с типом "medical_record" и описанием изменений
9. WHEN удаляется медицинская запись, THEN система SHALL создать запись в pet_change_log с типом "medical_record" и описанием удаленной записи
10. THE запись в changelog SHALL содержать user_id пользователя, выполнившего действие

### Требование 9: Производительность и оптимизация

**User Story:** Как пользователь системы, я хочу, чтобы API работал быстро, чтобы не ждать долго ответа.

#### Критерии приемки

1. THE система SHALL использовать подготовленные SQL запросы для предотвращения SQL инъекций
2. THE система SHALL использовать существующие индексы базы данных для быстрого поиска
3. WHEN выполняется запрос к базе данных, THEN система SHALL использовать connection pooling
4. THE система SHALL возвращать ответ на GET запросы в течение 200ms при нормальной нагрузке

### Требование 10: Интеграция с существующей архитектурой

**User Story:** Как разработчик, я хочу, чтобы новые endpoints следовали существующей архитектуре, чтобы код был консистентным.

#### Критерии приемки

1. THE новые handlers SHALL быть добавлены в файл backend/handlers/pets.go
2. THE новые routes SHALL быть зарегистрированы в backend/main.go
3. THE handlers SHALL использовать существующий middleware для аутентификации
4. THE handlers SHALL использовать существующие helper функции (sendError, parseJSONBody, proxyGatewayResponse)
5. THE handlers SHALL следовать существующему стилю кодирования и именованию
